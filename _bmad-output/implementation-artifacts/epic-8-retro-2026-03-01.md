# Rétrospective Epic 8 : Notifications Multi-Canal

**Date :** 2026-03-01
**Epic :** 8 — Notifications Multi-Canal
**Statut :** Complète (4/4 stories done)
**Rétrospective précédente :** Epic 7 (2026-03-01)

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 4/4 (100%) |
| Tests en fin d'epic | 291 (avant code review) / 303 (après) |
| Code review findings | H2 (send endpoint non protégé), M5 (dispatchers dead code) |
| Modèle Prisma | NotificationPreference |

## Ce qui a bien marché

### 1. Architecture multi-canal
- 3 canaux : WhatsApp (priorité), SMS (fallback), Push PWA (complément)
- Dispatchers par canal avec interface commune
- `sendMultiChannel` pour envoi simultané sur tous les canaux actifs

### 2. Préférences utilisateur
- Modèle `NotificationPreference` avec booléens par canal
- Valeurs par défaut : WhatsApp=true, SMS=true, Push=false
- GET/PUT API pour consultation et mise à jour
- Upsert Prisma pour création automatique

### 3. Notifications événementielles prédéfinies
- `notifyOrderStatusChange` — changement statut commande
- `notifyVendorNewOrder` — nouvelle commande pour vendeur
- `notifyVendorLowStock` — alerte stock critique
- `notifyRiderAssignment` — assignation mission rider

### 4. Tests bien structurés
- 8 tests service + 3 tests routes
- Mock du service WhatsApp pour isolation
- Couverture des préférences par défaut et personnalisées

## Défis et difficultés

### 1. Endpoint `/send` non protégé initialement
- Code review H2 : n'importe quel utilisateur authentifié pouvait envoyer des notifications
- Fix : `requireRole('ADMIN')` ajouté au preHandler
- Faille de sécurité qui aurait permis le spam

### 2. Dispatchers SMS et Push non implémentés
- Code review M5 : fonctions de dispatch déclarées mais jamais appelées
- SMS et Push sont des stubs pour le MVP
- WhatsApp est le seul canal réellement fonctionnel

### 3. Validation Zod manquante initialement
- Routes sans validation de schema
- Fix code review : `updatePreferencesSchema` et `sendNotificationSchema` dans `packages/shared/validators/notification.ts`

## Insights clés

1. **Tout endpoint d'envoi doit être protégé par rôle** — même en interne, un endpoint `/send` ouvert est un vecteur d'abus
2. **Les stubs SMS/Push sont acceptables** pour le MVP ivoirien — WhatsApp est le canal dominant
3. **Les préférences par défaut** doivent refléter le comportement le plus utile (opt-in WhatsApp/SMS)
4. **L'architecture multi-canal extensible** permet d'ajouter SMS réel et Push sans refactoring

## Dette technique

| Item | Priorité | Notes |
|------|----------|-------|
| SMS dispatcher réel | Medium | Intégration provider SMS Côte d'Ivoire |
| Push PWA dispatcher | Medium | Service Worker notification API |
| Appel proactif J+1 SLA breach | Low | Stub — nécessite intégration voix |
| Rate limiting notifications | Medium | Max 2-3 messages par commande |

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
