# Rétrospective Epic 2 : Catalogue Vendeur & Onboarding

**Date :** 2026-03-01
**Epic :** 2 — Catalogue Vendeur & Onboarding
**Statut :** Complète (6/6 stories done)
**Rétrospective précédente :** Epic 1 (2026-03-01)

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 6/6 (100%) |
| Tests ajoutés | 84 nouveaux tests |
| Tests totaux en fin d'epic | 167 |
| Code review findings | 7 (6 MEDIUM, 1 LOW — tous résolus) |
| Dette technique | 2 items |

## Ce qui a bien marché

### 1. Pipeline images complet (Story 2.3)
- Architecture async complète : upload R2 → pgqueue → Sharp variants → Gemini VLM → CatalogItem draft
- pgqueue MVP avec `SELECT FOR UPDATE SKIP LOCKED` — simple et efficace
- 4 variantes WebP (thumb/small/medium/large) générées automatiquement
- Fallback gracieux quand quota Gemini atteint (80% threshold)

### 2. Détection bait-and-switch (Story 2.4)
- Prix change >50% en <1h → flag automatique + log événement
- Guards de publication : prix obligatoire pour DRAFT → PUBLISHED
- PATCH sémantique propre (champs absents = pas de modification)

### 3. Onboarding vendeur structuré (Story 2.1)
- Transaction atomique pour création Vendor + VendorKyc
- Validation conditionnelle Zod (FORMAL → RCCM, INFORMAL → CNI)
- Distinction publique/privée des documents KYC (FR48)

### 4. Tests bien structurés
- 84 nouveaux tests avec patterns réutilisables
- Mock strategies pour multipart upload, R2, et Gemini
- Couverture des edge cases (vendor déjà actif, stock toggle)

## Défis et difficultés

### 1. Migration Prisma sans DB locale
- Création manuelle de SQL migrations avec fake DATABASE_URL
- Pattern récurrent depuis Epic 1 — workflow accepté mais pas idéal

### 2. Zod `.refine()` incompatible avec zodToFastify
- Validation conditionnelle (FORMAL vs INFORMAL) non convertible en JSON Schema
- Solution : validation au niveau service, pas au niveau route schema

### 3. Complexité des mocks multipart
- Tests upload avec `@fastify/multipart` nécessitent des mocks élaborés
- Pattern établi mais verbeux

## Insights clés

1. **pgqueue avec PostgreSQL natif** est suffisant pour le MVP (~10-20 jobs/jour)
2. **La validation Zod conditionnelle** doit rester au service level quand `.refine()` est utilisé
3. **Le pattern transaction Prisma** garantit l'atomicité pour les créations liées (Vendor + KYc)
4. **Sharp async** ne bloque pas l'event loop grâce au pattern queue

## Dette technique

| Item | Priorité | Notes |
|------|----------|-------|
| Meilisearch sync | Medium | Phase 2 (> 50K refs ou 15%+ zero-result) |
| pgqueue → Redis/BullMQ | Low | Suffisant MVP, migration documentée |

## Suivi actions Epic 1

- ✅ Patterns Fastify `fp()` appliqués systématiquement
- ✅ Code review exécutée (7 findings, tous résolus)
- ✅ Zod schemas dans `packages/shared/validators/`

## Préparation Epic 3

- ✅ Catalogue vendeur opérationnel (données pour recherche/navigation)
- ✅ Images WebP disponibles via CDN R2
- À créer : pg_trgm extension + search_synonyms table
- À créer : VIN decoding service (NHTSA VPIC API)

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
