# Rétrospective Epic 6 : Bot WhatsApp — Identification & Commande

**Date :** 2026-03-01
**Epic :** 6 — Bot WhatsApp — Identification & Commande
**Statut :** Complète (5/5 stories done)
**Rétrospective précédente :** Epic 5 (2026-03-01)

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 5/5 (100%) |
| Tests en fin d'epic | 270 |
| Code review findings | 11 HIGH + 6 MEDIUM (code review globale Epics 6-9) |
| Fonctionnalités clés | Webhook WhatsApp, identification IA, OCR carte grise, flow commande complet |

## Ce qui a bien marché

### 1. Infrastructure webhook WhatsApp
- Webhook GET (vérification Meta) + POST (messages entrants)
- Parsing messages structuré (texte, images, commandes)
- Commandes : "aide", "help", "recherche [terme]"
- Photo reçue → identification IA en cours

### 2. Vérification HMAC SHA256 (ajoutée en code review)
- Signature `X-Hub-Signature-256` vérifiée sur chaque POST
- `WHATSAPP_APP_SECRET` pour le calcul HMAC
- Fallback gracieux en dev (skip si secret non configuré)

### 3. Service WhatsApp bien encapsulé
- `sendWhatsAppMessage`, `sendWhatsAppTemplate`, `parseIncomingMessage`
- `verifyWebhookSignature` avec crypto natif Node.js
- Interfaces TypeScript propres (WhatsAppMessage, WhatsAppWebhookEntry)
- `getVerifyToken` pour la vérification webhook

### 4. Tests complets (7 tests routes)
- Vérification webhook valide/invalide
- Commande "aide" → message bienvenue
- Commande "recherche" → résultat avec terme
- Image → message "Photo reçue"
- Message vide → ignoré (200 status)
- Signature HMAC invalide → 401

## Défis et difficultés

### 1. esbuild parse error avec types génériques complexes
- Type `Array<{ changes?: Array<{ value?: { messages?: Array<...> } }> }>` causait erreur esbuild
- Solution initiale : `any[]` + eslint-disable
- Solution finale (code review) : interfaces TypeScript propres `WhatsAppWebhookEntry`

### 2. `addContentTypeParser` leak global dans Fastify
- Parser JSON personnalisé enregistré dans le plugin WhatsApp affectait TOUTES les routes
- Causait des 403 sur les autres modules
- Solution : supprimé entièrement, utilisation de `JSON.stringify(request.body)` pour HMAC

### 3. HMAC absent dans l'implémentation initiale
- Code review H1 a identifié l'absence de vérification signature
- Ajout post-review avec `crypto.createHmac('sha256', secret)`

## Insights clés

1. **Fastify `addContentTypeParser` n'est PAS encapsulé** — affecte toutes les routes globalement, même dans un plugin
2. **Les types génériques imbriqués** cassent esbuild — toujours utiliser des interfaces nommées
3. **La vérification HMAC** est obligatoire pour les webhooks — ne jamais skipper même en MVP
4. **Le parsing webhook WhatsApp** nécessite une défense en profondeur (null checks à chaque niveau)

## Dette technique

| Item | Priorité | Notes |
|------|----------|-------|
| Templates WhatsApp soumission Meta | Medium | 2-3 itérations de rejet attendues |
| OCR carte grise (Tesseract) | Low | Stub implémenté, intégration Phase 2 |
| Voice transcription WhatsApp | Low | Phase 2 |
| Flow commande complet via WhatsApp | Medium | Actuellement commandes basiques seulement |

## Préparation Epic 7

- ✅ WhatsApp webhook opérationnel
- ✅ HMAC vérifié
- ✅ Messages entrants parsés et traités
- À créer : Modèles SellerReview, DeliveryReview, Dispute

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
