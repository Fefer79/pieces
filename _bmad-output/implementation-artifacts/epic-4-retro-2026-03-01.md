# Rétrospective Epic 4 : Commande Tripartite & Paiement

**Date :** 2026-03-01
**Epic :** 4 — Commande Tripartite & Paiement
**Statut :** Complète (7/7 stories done)
**Rétrospective précédente :** Epic 3 (2026-03-01)

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 7/7 (100%) |
| Tests en fin d'epic | 230+ |
| Complexité | Élevée — state machine 10 états, intégration paiement, mode guest |

## Ce qui a bien marché

### 1. State machine commande robuste (Story 4.1)
- `OrderStateMachine` TypeScript avec transitions typées
- 10 états : DRAFT → PENDING_PAYMENT → PAID → VENDOR_CONFIRMED → DISPATCHED → IN_TRANSIT → DELIVERED → CONFIRMED → COMPLETED → CANCELLED
- Audit trail via `order_events` table
- Tests exhaustifs des transitions valides et invalides (11 tests dédiés)

### 2. Flux tripartite mécanicien → propriétaire → vendeur
- Mécanicien prescrit et partage lien
- Propriétaire voit options multi-vendeurs avec prix transparents
- Mode guest propriétaire sans compte (React Server Component < 5KB JS)
- UX page `/choose/[orderId]` légère et rapide

### 3. Intégration CinetPay
- Webhook sécurisé pour notifications de paiement
- Séquestre automatique à réception paiement
- Remboursement automatique si vendeur ne confirme pas

### 4. Auto-cancellation vendeur 45 min
- Timeout automatique si vendeur ne confirme/decline pas
- Libération séquestre + remboursement acheteur
- Pattern pgqueue pour job planifié

### 5. Panier multi-références
- Support multi-pièces dans une commande
- Livraison consolidée
- Calcul total dynamique

## Défis et difficultés

### 1. Complexité de la state machine
- 10 états avec transitions multiples
- Chaque transition déclenche des side effects (paiement, notification, stock)
- Tests nécessaires pour chaque combinaison état/action

### 2. Mode guest propriétaire
- React Server Component pour minimiser JS
- Pas de JWT/auth pour le propriétaire guest
- Sécurité via token unique dans l'URL

### 3. Webhook CinetPay sécurité
- Vérification signature webhook
- Idempotence des callbacks (même paiement peut être notifié 2x)
- Gestion des états intermédiaires (pending → accepted/rejected)

### 4. Annulation et remboursement
- Multiple scénarios d'annulation (acheteur, timeout vendeur, erreur paiement)
- Chaque scénario a un flux de remboursement différent
- Tests d'intégration complexes

## Insights clés

1. **La state machine typée** est indispensable pour un flux commande complexe — investissement initial élevé mais évite les bugs d'état
2. **Le mode guest RSC** prouve que Next.js App Router peut servir des pages légères (<5 KB JS)
3. **L'idempotence des webhooks** est critique — CinetPay peut envoyer le même callback multiple fois
4. **Le timeout 45 min** nécessite un job planifié fiable — pgqueue suffisant pour MVP

## Dette technique

| Item | Priorité | Notes |
|------|----------|-------|
| pgqueue pour timeouts → Redis | Low | Fiable pour le volume MVP |
| Tests E2E flux complet | Medium | Unitaires + intégration suffisants pour l'instant |
| Notifications post-paiement | Medium | Implémentées dans Epic 8 |

## Préparation Epic 5

- ✅ State machine commande opérationnelle
- ✅ Modèle Order avec tous les champs nécessaires
- ✅ Séquestre et paiement fonctionnels
- À créer : Modèle Delivery avec tracking GPS
- À créer : Interface mission rider

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
