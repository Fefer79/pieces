# Rétrospective Epic 1 : Fondation Projet & Authentification

**Date :** 2026-03-01
**Epic :** 1 — Fondation Projet & Authentification
**Statut :** Complète (5/5 stories done)
**Première rétrospective :** Oui

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 5/5 (100%) |
| Tests en fin d'epic | 67 |
| Erreurs lint | 0 |
| Erreurs build | 0 |
| Bundle First Load JS | 102 KB (budget < 200 KB) |
| Incidents production | 0 |
| Code review findings critiques | 2 CRITICAL, 2 HIGH (Story 1.2) |
| Dette technique items | 5 (documentés) |

## Participants

- Bob (Scrum Master) — facilitation
- Alice (Product Owner) — vision produit
- Charlie (Senior Dev) — architecture technique
- Dana (QA Engineer) — qualité et tests
- Elena (Junior Dev) — développement
- F (Project Lead) — direction projet

---

## Ce qui a bien marché

### 1. Architecture et patterns fondateurs
- Pattern `buildApp()` pour un serveur Fastify testable
- `AppError` centralisé pour un format d'erreur uniforme
- `requireAuth` / `requireRole` / `requireConsent` comme middleware réutilisable
- TypeScript strict mode dès le départ

### 2. Validation Zod comme source unique de vérité
- Schemas partagés dans `packages/shared/validators/`
- `zodToFastify()` pour convertir Zod → JSON Schema → Swagger
- Validation côté client ET serveur avec le même schema

### 3. Flux d'authentification OTP
- UX mobile-first avec 6 champs OTP auto-focus
- Intégration fluide Supabase Auth ↔ Prisma User sync
- Gestion propre du cycle de vie des tokens

### 4. Conformité ARTCI
- Consentement bloquant avec modal accessible (ARIA)
- Export de données personnelles
- Demande de suppression avec audit trail

### 5. Tests structurés
- 67 tests avec pattern `vi.mock()` réutilisable
- Tests d'intégration routes avec `app.inject()`
- Isolation des tests avec `vi.stubEnv()`

---

## Défis et difficultés

### 1. Plugin scoping Fastify (récurrent — 2/5 stories)
**Stories affectées :** 1.1, 1.2
**Problème :** `setErrorHandler` et rate limiter dans le scope plugin ne s'appliquaient qu'au plugin, pas globalement.
**Solution :** Wrapper avec `fp()` pour les plugins qui doivent être globaux.
**Impact :** Perte de temps à debugger, refactoring nécessaire.

### 2. Findings critiques en code review (Story 1.2)
**Problème :** `requireAuth` ne récupérait pas les rôles depuis Prisma ; le flux web bypassait l'API sans créer d'utilisateur Prisma.
**Impact :** Sans code review, tout le système RBAC aurait été cassé pour les epics suivants.
**Leçon :** La code review adversariale est indispensable, pas optionnelle.

### 3. Stale TypeScript artifacts (2/5 stories)
**Stories affectées :** 1.2, 1.5
**Problème :** Schemas Zod compilés obsolètes causaient des erreurs fantômes dans les tests.
**Solution :** Clean des artifacts avant exécution des tests.

### 4. Versions npm optimistes (3/5 stories)
**Problème :** Versions spécifiées dans les specs (Swagger UI v6, ESLint 10, etc.) n'existaient pas encore.
**Solution :** Adaptation à chaque fois aux versions disponibles.
**Leçon :** Valider les versions sur npmjs.com avant de les inclure dans les specs.

### 5. Test isolation
**Problème :** `start()` appelé au niveau module causait `EADDRINUSE` en tests parallèles.
**Solution :** Guard `NODE_ENV !== 'test'`.

---

## Insights clés

1. **Le plugin scoping Fastify est un piège récurrent** — toujours utiliser `fp()` pour les plugins globaux
2. **La code review adversariale sauve des vies** — 2 findings CRITICAL auraient compromis toute l'authentification
3. **Zod comme source unique de vérité** fonctionne remarquablement pour la validation cross-stack
4. **La documentation in-story des challenges** crée une base de connaissances précieuse
5. **L'upsert Prisma sur chaque requête auth** garantit la synchronisation User sans race conditions

---

## Dette technique

| Item | Priorité | Statut | Notes |
|------|----------|--------|-------|
| Response schemas Swagger | Low | Différé Phase 2 | Request schemas suffisants pour MVP |
| Intégration Sentry | Medium | En attente DSN | Infrastructure externe |
| Configuration Cloudflare | Low | Infrastructure | Health checks externes |
| WhatsApp templates | Low | Différé | 2-3 itérations de rejet attendues |
| Service Worker (Serwist) | Low | Différé Story 3.6 | Offline-first PWA |

---

## Actions

### Améliorations processus

1. **Documenter les patterns Fastify dans CLAUDE.md**
   - Owner : Charlie (Senior Dev)
   - Critère de succès : Section "Fastify Patterns" avec `fp()`, `buildApp()`, plugin scoping

2. **Code review systématique après chaque story**
   - Owner : Bob (Scrum Master)
   - Critère de succès : Chaque story passe par `/bmad-bmm-code-review` avant `done`

3. **Valider les versions npm avant spécification**
   - Owner : Alice (Product Owner) + Charlie
   - Critère de succès : Versions vérifiées sur npmjs.com

### Accords d'équipe

- Toujours wrapper les plugins Fastify globaux avec `fp()`
- Exclure `*.test.ts` du `tsc --noEmit` build
- Utiliser `vi.stubEnv()` pour les variables d'environnement en tests
- Zod schemas dans `packages/shared/validators/` comme source unique
- Format d'erreur : 422 (validation), 400 (logique), 401/403 (auth)

---

## Préparation Epic 2 : Catalogue Vendeur & Onboarding

### Dépendances sur Epic 1
- ✅ `requireAuth` / `requireRole` — opérationnel
- ✅ Prisma User model avec roles — opérationnel
- ✅ Pattern `buildApp()` + module routing — opérationnel
- ✅ `zodToFastify()` — opérationnel
- ✅ `AppError` — opérationnel

### Nouvelles capacités requises
- Cloudflare R2 (stockage images) — lib à créer
- Sharp (traitement images WebP) — à installer
- Google Gemini VLM (identification pièces) — intégration à créer
- pgqueue (jobs asynchrones) — à implémenter
- IndexedDB (offline bulk upload) — frontend

### Évaluation de préparation
- **Aucune découverte significative** nécessitant de modifier le plan Epic 2
- Les fondations d'Epic 1 sont solides et prêtes
- Les patterns de test sont transférables (`vi.mock()` pour R2/Gemini)

---

## Résumé final

Epic 1 a posé des fondations solides : monorepo Turborepo, auth OTP, multi-rôles, conformité ARTCI, et documentation API. Les 5 stories sont livrées avec 67 tests, zéro erreur, et une architecture modulaire prête pour les 8 epics suivants. Les principaux enseignements — plugin scoping Fastify et importance de la code review adversariale — sont documentés pour éviter les mêmes pièges.

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
