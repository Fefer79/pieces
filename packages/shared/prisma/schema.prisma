datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  MECHANIC
  OWNER
  SELLER
  RIDER
  ADMIN
  ENTERPRISE
}

model User {
  id            String   @id @default(uuid())
  supabaseId    String   @unique @map("supabase_id")
  phone         String   @unique
  roles         Role[]
  activeContext  Role?    @map("active_context")
  consentedAt   DateTime? @map("consented_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  dataDeletionRequests DataDeletionRequest[]
  vendor               Vendor?
  vehicles             UserVehicle[]

  @@map("users")
  @@index([phone], name: "idx_users_phone")
}

enum DeletionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VendorStatus {
  PENDING_ACTIVATION
  ACTIVE
  PAUSED
}

enum VendorType {
  FORMAL
  INFORMAL
}

enum KycType {
  RCCM
  CNI
}

enum GuaranteeType {
  RETURN_48H
  WARRANTY_30D
}

enum CatalogItemStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum JobType {
  IMAGE_PROCESS_VARIANTS
  CATALOG_AI_IDENTIFY
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Vendor {
  id          String       @id @default(uuid())
  userId      String       @unique @map("user_id")
  user        User         @relation(fields: [userId], references: [id])
  shopName    String       @map("shop_name")
  contactName String       @map("contact_name")
  phone       String
  vendorType  VendorType   @map("vendor_type")
  status      VendorStatus @default(PENDING_ACTIVATION)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  deliveryZones String[]         @default([]) @map("delivery_zones")

  kyc                 VendorKyc?
  guaranteeSignatures VendorGuaranteeSignature[]
  catalogItems        CatalogItem[]

  @@map("vendors")
  @@index([phone], name: "idx_vendors_phone")
}

model VendorGuaranteeSignature {
  id            String        @id @default(uuid())
  vendorId      String        @map("vendor_id")
  vendor        Vendor        @relation(fields: [vendorId], references: [id])
  guaranteeType GuaranteeType @map("guarantee_type")
  signedAt      DateTime      @default(now()) @map("signed_at")

  @@map("vendor_guarantee_signatures")
  @@unique([vendorId, guaranteeType], name: "uq_vendor_guarantee_type")
}

model VendorKyc {
  id             String   @id @default(uuid())
  vendorId       String   @unique @map("vendor_id")
  vendor         Vendor   @relation(fields: [vendorId], references: [id])
  kycType        KycType  @map("kyc_type")
  documentNumber String   @map("document_number")
  isPublic       Boolean  @default(false) @map("is_public")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("vendor_kyc")
}

model DataDeletionRequest {
  id          String                @id @default(uuid())
  userId      String                @map("user_id")
  user        User                  @relation(fields: [userId], references: [id])
  status      DeletionRequestStatus @default(PENDING)
  requestedAt DateTime              @default(now()) @map("requested_at")
  processedAt DateTime?             @map("processed_at")

  @@map("data_deletion_requests")
  @@index([userId], name: "idx_data_deletion_requests_user")
}

model CatalogItem {
  id                   String            @id @default(uuid())
  vendorId             String            @map("vendor_id")
  vendor               Vendor            @relation(fields: [vendorId], references: [id])
  name                 String?
  category             String?
  oemReference         String?           @map("oem_reference")
  vehicleCompatibility String?           @map("vehicle_compatibility")
  suggestedPrice       Int?              @map("suggested_price")
  price                Int?
  status               CatalogItemStatus @default(DRAFT)
  imageOriginalUrl     String?           @map("image_original_url")
  imageThumbUrl        String?           @map("image_thumb_url")
  imageSmallUrl        String?           @map("image_small_url")
  imageMediumUrl       String?           @map("image_medium_url")
  imageLargeUrl        String?           @map("image_large_url")
  aiConfidence         Float?            @map("ai_confidence")
  aiGenerated          Boolean           @default(true) @map("ai_generated")
  qualityScore         Float?            @map("quality_score")
  qualityIssue         String?           @map("quality_issue")
  inStock              Boolean           @default(true) @map("in_stock")
  priceUpdatedAt       DateTime?         @map("price_updated_at")
  priceAlertFlag       Boolean           @default(false) @map("price_alert_flag")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")

  @@map("catalog_items")
  @@index([vendorId, status], name: "idx_catalog_items_vendor_status")
}

model Job {
  id          String    @id @default(uuid())
  type        JobType
  status      JobStatus @default(PENDING)
  payload     Json
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  error       String?
  scheduledAt DateTime? @map("scheduled_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("jobs")
  @@index([status, type], name: "idx_jobs_status_type")
}

model UserVehicle {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  brand     String
  model     String
  year      Int
  vin       String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_vehicles")
  @@index([userId], name: "idx_user_vehicles_user")
}

model SearchSynonym {
  id         String @id @default(uuid())
  typo       String @unique
  correction String

  @@map("search_synonyms")
}
