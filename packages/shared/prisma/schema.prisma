datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  MECHANIC
  OWNER
  SELLER
  RIDER
  ADMIN
  ENTERPRISE
}

model User {
  id            String   @id @default(uuid())
  supabaseId    String   @unique @map("supabase_id")
  phone         String   @unique
  roles         Role[]
  activeContext  Role?    @map("active_context")
  consentedAt   DateTime? @map("consented_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  dataDeletionRequests DataDeletionRequest[]
  vendor               Vendor?
  vehicles             UserVehicle[]
  initiatedOrders      Order[]  @relation("OrderInitiator")
  riderDeliveries      Delivery[] @relation("DeliveryRider")
  sellerReviews        SellerReview[] @relation("SellerReviewer")
  deliveryReviews      DeliveryReview[] @relation("DeliveryReviewer")
  disputes             Dispute[] @relation("DisputeOpener")

  @@map("users")
  @@index([phone], name: "idx_users_phone")
}

enum DeletionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VendorStatus {
  PENDING_ACTIVATION
  ACTIVE
  PAUSED
}

enum VendorType {
  FORMAL
  INFORMAL
}

enum KycType {
  RCCM
  CNI
}

enum GuaranteeType {
  RETURN_48H
  WARRANTY_30D
}

enum CatalogItemStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  VENDOR_CONFIRMED
  DISPATCHED
  IN_TRANSIT
  DELIVERED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  ORANGE_MONEY
  MTN_MOMO
  WAVE
  COD
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

enum DeliveryStatus {
  PENDING_ASSIGNMENT
  ASSIGNED
  PICKUP_IN_PROGRESS
  IN_TRANSIT
  DELIVERED
  CONFIRMED
  RETURNED
}

enum DeliveryMode {
  EXPRESS
  STANDARD
}

enum JobType {
  IMAGE_PROCESS_VARIANTS
  CATALOG_AI_IDENTIFY
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Vendor {
  id          String       @id @default(uuid())
  userId      String       @unique @map("user_id")
  user        User         @relation(fields: [userId], references: [id])
  shopName    String       @map("shop_name")
  contactName String       @map("contact_name")
  phone       String
  vendorType  VendorType   @map("vendor_type")
  status      VendorStatus @default(PENDING_ACTIVATION)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  deliveryZones String[]         @default([]) @map("delivery_zones")

  kyc                 VendorKyc?
  guaranteeSignatures VendorGuaranteeSignature[]
  catalogItems        CatalogItem[]

  @@map("vendors")
  @@index([phone], name: "idx_vendors_phone")
}

model VendorGuaranteeSignature {
  id            String        @id @default(uuid())
  vendorId      String        @map("vendor_id")
  vendor        Vendor        @relation(fields: [vendorId], references: [id])
  guaranteeType GuaranteeType @map("guarantee_type")
  signedAt      DateTime      @default(now()) @map("signed_at")

  @@map("vendor_guarantee_signatures")
  @@unique([vendorId, guaranteeType], name: "uq_vendor_guarantee_type")
}

model VendorKyc {
  id             String   @id @default(uuid())
  vendorId       String   @unique @map("vendor_id")
  vendor         Vendor   @relation(fields: [vendorId], references: [id])
  kycType        KycType  @map("kyc_type")
  documentNumber String   @map("document_number")
  isPublic       Boolean  @default(false) @map("is_public")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("vendor_kyc")
}

model DataDeletionRequest {
  id          String                @id @default(uuid())
  userId      String                @map("user_id")
  user        User                  @relation(fields: [userId], references: [id])
  status      DeletionRequestStatus @default(PENDING)
  requestedAt DateTime              @default(now()) @map("requested_at")
  processedAt DateTime?             @map("processed_at")

  @@map("data_deletion_requests")
  @@index([userId], name: "idx_data_deletion_requests_user")
}

model CatalogItem {
  id                   String            @id @default(uuid())
  vendorId             String            @map("vendor_id")
  vendor               Vendor            @relation(fields: [vendorId], references: [id])
  name                 String?
  category             String?
  oemReference         String?           @map("oem_reference")
  vehicleCompatibility String?           @map("vehicle_compatibility")
  suggestedPrice       Int?              @map("suggested_price")
  price                Int?
  status               CatalogItemStatus @default(DRAFT)
  imageOriginalUrl     String?           @map("image_original_url")
  imageThumbUrl        String?           @map("image_thumb_url")
  imageSmallUrl        String?           @map("image_small_url")
  imageMediumUrl       String?           @map("image_medium_url")
  imageLargeUrl        String?           @map("image_large_url")
  aiConfidence         Float?            @map("ai_confidence")
  aiGenerated          Boolean           @default(true) @map("ai_generated")
  qualityScore         Float?            @map("quality_score")
  qualityIssue         String?           @map("quality_issue")
  inStock              Boolean           @default(true) @map("in_stock")
  priceUpdatedAt       DateTime?         @map("price_updated_at")
  priceAlertFlag       Boolean           @default(false) @map("price_alert_flag")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")

  @@map("catalog_items")
  @@index([vendorId, status], name: "idx_catalog_items_vendor_status")
}

model Job {
  id          String    @id @default(uuid())
  type        JobType
  status      JobStatus @default(PENDING)
  payload     Json
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  error       String?
  scheduledAt DateTime? @map("scheduled_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("jobs")
  @@index([status, type], name: "idx_jobs_status_type")
}

model UserVehicle {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  brand     String
  model     String
  year      Int
  vin       String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_vehicles")
  @@index([userId], name: "idx_user_vehicles_user")
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_BUYER
  RESOLVED_SELLER
  CLOSED
}

model SellerReview {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  vendorId  String   @map("vendor_id")
  reviewerId String  @map("reviewer_id")
  reviewer  User     @relation("SellerReviewer", fields: [reviewerId], references: [id])
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("seller_reviews")
  @@unique([orderId, reviewerId], name: "uq_seller_review_order_user")
  @@index([vendorId], name: "idx_seller_reviews_vendor")
}

model DeliveryReview {
  id         String   @id @default(uuid())
  deliveryId String   @map("delivery_id")
  riderId    String   @map("rider_id")
  reviewerId String   @map("reviewer_id")
  reviewer   User     @relation("DeliveryReviewer", fields: [reviewerId], references: [id])
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("delivery_reviews")
  @@unique([deliveryId, reviewerId], name: "uq_delivery_review_delivery_user")
  @@index([riderId], name: "idx_delivery_reviews_rider")
}

model Dispute {
  id          String        @id @default(uuid())
  orderId     String        @map("order_id")
  openedBy    String        @map("opened_by")
  opener      User          @relation("DisputeOpener", fields: [openedBy], references: [id])
  status      DisputeStatus @default(OPEN)
  reason      String
  evidence    String[]      @default([])
  resolution  String?
  resolvedAt  DateTime?     @map("resolved_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("disputes")
  @@index([orderId], name: "idx_disputes_order")
}

model SearchSynonym {
  id         String @id @default(uuid())
  typo       String @unique
  correction String

  @@map("search_synonyms")
}

model Order {
  id              String        @id @default(uuid())
  initiatorId     String        @map("initiator_id")
  initiator       User          @relation("OrderInitiator", fields: [initiatorId], references: [id])
  ownerPhone      String?       @map("owner_phone")
  status          OrderStatus   @default(DRAFT)
  paymentMethod   PaymentMethod? @map("payment_method")
  shareToken      String        @unique @map("share_token")
  totalAmount     Int           @default(0) @map("total_amount")
  deliveryFee     Int           @default(0) @map("delivery_fee")
  laborCost       Int?          @map("labor_cost")
  vendorConfirmedAt DateTime?   @map("vendor_confirmed_at")
  paidAt          DateTime?     @map("paid_at")
  cancelledAt     DateTime?     @map("cancelled_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  items           OrderItem[]
  events          OrderEvent[]
  escrow          EscrowTransaction?
  delivery        Delivery?

  @@map("orders")
  @@index([initiatorId], name: "idx_orders_initiator")
  @@index([status], name: "idx_orders_status")
}

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String   @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id])
  catalogItemId   String   @map("catalog_item_id")
  vendorId        String   @map("vendor_id")
  vendorShopName  String   @map("vendor_shop_name")
  name            String
  category        String?
  priceSnapshot   Int      @map("price_snapshot")
  quantity        Int      @default(1)
  imageThumbUrl   String?  @map("image_thumb_url")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("order_items")
  @@index([orderId], name: "idx_order_items_order")
}

model OrderEvent {
  id        String      @id @default(uuid())
  orderId   String      @map("order_id")
  order     Order       @relation(fields: [orderId], references: [id])
  fromStatus OrderStatus? @map("from_status")
  toStatus  OrderStatus @map("to_status")
  actor     String?
  note      String?
  createdAt DateTime    @default(now()) @map("created_at")

  @@map("order_events")
  @@index([orderId], name: "idx_order_events_order")
}

model Delivery {
  id              String         @id @default(uuid())
  orderId         String         @unique @map("order_id")
  order           Order          @relation(fields: [orderId], references: [id])
  riderId         String?        @map("rider_id")
  rider           User?          @relation("DeliveryRider", fields: [riderId], references: [id])
  status          DeliveryStatus @default(PENDING_ASSIGNMENT)
  mode            DeliveryMode   @default(STANDARD)
  pickupAddress   String?        @map("pickup_address")
  pickupLat       Float?         @map("pickup_lat")
  pickupLng       Float?         @map("pickup_lng")
  deliveryAddress String?        @map("delivery_address")
  deliveryLat     Float?         @map("delivery_lat")
  deliveryLng     Float?         @map("delivery_lng")
  riderLat        Float?         @map("rider_lat")
  riderLng        Float?         @map("rider_lng")
  estimatedAt     DateTime?      @map("estimated_at")
  pickedUpAt      DateTime?      @map("picked_up_at")
  deliveredAt     DateTime?      @map("delivered_at")
  confirmedAt     DateTime?      @map("confirmed_at")
  clientAbsent    Boolean        @default(false) @map("client_absent")
  codAmount       Int?           @map("cod_amount")
  receiptPhotoUrl String?        @map("receipt_photo_url")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("deliveries")
  @@index([riderId], name: "idx_deliveries_rider")
  @@index([status], name: "idx_deliveries_status")
}

model EscrowTransaction {
  id        String       @id @default(uuid())
  orderId   String       @unique @map("order_id")
  order     Order        @relation(fields: [orderId], references: [id])
  amount    Int
  status    EscrowStatus @default(HELD)
  heldAt    DateTime     @default(now()) @map("held_at")
  releasedAt DateTime?   @map("released_at")
  refundedAt DateTime?   @map("refunded_at")

  @@map("escrow_transactions")
}
