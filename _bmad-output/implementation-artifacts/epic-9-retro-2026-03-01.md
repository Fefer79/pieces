# Rétrospective Epic 9 : Administration, Historique & Enterprise

**Date :** 2026-03-01
**Epic :** 9 — Administration, Historique & Enterprise
**Statut :** Complète (3/3 stories done)
**Rétrospective précédente :** Epic 8 (2026-03-01)

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 3/3 (100%) |
| Tests finaux projet | 303 (36 fichiers test) |
| Code review findings | M1 (status as never), M4 (route placement) |
| Pages PWA | Historique commandes, Dashboard admin |

## Ce qui a bien marché

### 1. Historique commandes utilisateur
- Pagination (page/limit query params)
- Inclut items avec prix snapshot et quantité
- Inclut statut livraison si applicable
- Labels statuts en français pour l'UX

### 2. Dashboard admin complet
- `totalUsers`, `totalVendors`, `totalOrders`, `totalDisputes`
- Compteurs via `prisma.model.count()` — simple et efficace
- Protégé par `requireRole('ADMIN')`
- Liste utilisateurs, commandes, vendeurs avec pagination

### 3. Déplacement route historique (code review M4)
- Initialement sous `/admin/orders/history` — mal placé
- Déplacé vers `/orders/history` avec `requireAuth` seulement
- L'historique appartient à l'utilisateur, pas à l'admin
- PWA page mise à jour pour pointer vers la bonne URL

### 4. Enterprise stub prêt
- Modèle conceptuel pour gestion membres enterprise
- `1 compte = 1 tenant` (v1 simplification)
- Invitation membres + rôles internes
- Prêt pour extension Phase 2

## Défis et difficultés

### 1. Type bypass `status as never` (code review M1)
- Cast TypeScript dangereux pour filtrer par statut de commande
- Fix : validation contre `VALID_ORDER_STATUSES` array avec type guard
- Pattern plus sûr et auto-documenté

### 2. Route placement incorrect
- Historique commandes sous `/admin` alors que c'est une feature utilisateur
- Symptôme d'un epic "fourre-tout" en fin de sprint
- Fix clean mais nécessitant update PWA page + tests

### 3. Enterprise scope limité
- v1 = stub avec structure minimale
- Pas de vrai multi-tenant, pas d'isolation données
- Acceptable pour MVP mais à solidifier avant production enterprise

## Insights clés

1. **Le placement des routes reflète l'architecture** — `/admin/orders/history` vs `/orders/history` sont sémantiquement très différents
2. **Les type casts dangereux** (`as never`) doivent toujours être remplacés par des validations runtime
3. **Les dashboards admin** sont simples avec Prisma `count()` mais deviennent complexes avec filtres/dates
4. **L'enterprise multi-tenant** est un projet en soi — ne pas sous-estimer sa complexité

## Dette technique

| Item | Priorité | Notes |
|------|----------|-------|
| Enterprise multi-tenant réel | High | Isolation données, audit ARTCI |
| Export audit logs | Medium | Phase 2 (FR63) |
| DTO Projection confidentialité | Medium | Matrice rôle → champs visibles |
| Dashboard filtres avancés | Low | Date range, statut, vendeur |

---

## Bilan Global du Sprint

### Métriques finales projet
- **9 epics** complétés (45 stories)
- **303 tests** passants (36 fichiers)
- **0 erreurs** lint et build
- **1 code review globale** avec 11 HIGH + 6 MEDIUM findings → tous résolus
- **17 fichiers** modifiés dans le fix code review

### Patterns établis pour le projet
1. Turborepo monorepo avec pnpm workspaces
2. Fastify + Prisma + Zod comme stack API
3. Next.js PWA avec Tailwind CSS
4. `vi.mock()` + `buildApp()` pour tests d'intégration
5. `requireAuth` + `requireRole` pour RBAC
6. `zodToFastify()` pour validation + Swagger auto
7. `AppError` centralisé pour format erreur uniforme
8. Code review adversariale systématique

### Top 5 leçons du sprint entier
1. **`fp()` obligatoire** pour les plugins Fastify globaux
2. **La code review adversariale** est indispensable — trouve des failles critiques
3. **`vi.clearAllMocks()` ≠ `vi.resetAllMocks()`** — piège vitest subtil
4. **Les vérifications de propriété** sont aussi importantes que l'authentification
5. **Fastify `addContentTypeParser` leak global** — ne jamais enregistrer dans un plugin

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
*Dernière rétrospective du sprint — toutes les 45 stories livrées.*
