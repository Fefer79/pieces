# Rétrospective Epic 7 : Évaluations, Confiance & Litiges

**Date :** 2026-03-01
**Epic :** 7 — Évaluations, Confiance & Litiges
**Statut :** Complète (6/6 stories done)
**Rétrospective précédente :** Epic 6 (2026-03-01)

---

## Résumé Epic

| Métrique | Valeur |
|----------|--------|
| Stories complétées | 6/6 (100%) |
| Tests en fin d'epic | 280+ |
| Code review findings | H3-H5 (validation, ownership) résolus dans code review globale |
| Modèles Prisma | SellerReview, DeliveryReview, Dispute |

## Ce qui a bien marché

### 1. Système d'évaluation vendeur et livreur
- `SellerReview` : orderId, vendorId, reviewerId, rating (1-5), comment
- `DeliveryReview` : deliveryId, riderId, reviewerId, rating (1-5), comment
- API publique GET vendor reviews avec agrégation Prisma `_avg` + `_count`
- Calcul note moyenne côté DB (pas en mémoire)

### 2. Système de litiges structuré
- Ouverture litige avec raison (min 5 chars, max 2000)
- Statuts : OPEN → RESOLVED_BUYER | RESOLVED_SELLER
- Résolution par ADMIN uniquement (requireRole)
- `inFavorOf: 'buyer' | 'seller'` pour décision claire

### 3. Vérifications de propriété (ajoutées en code review)
- `createSellerReview` : vérifie que le reviewer est l'initiateur de la commande
- `createDeliveryReview` : vérifie que le reviewer est propriétaire de la livraison
- `openDispute` : vérifie que l'utilisateur est l'initiateur de la commande
- `getDisputesByOrder` : ownership check + admin bypass

### 4. Validation Zod sur toutes les routes (ajoutée en code review)
- `createSellerReviewSchema`, `createDeliveryReviewSchema`
- `openDisputeSchema`, `resolveDisputeSchema`
- Schemas dans `packages/shared/validators/review.ts`

## Défis et difficultés

### 1. Ownership verification manquante initialement
- Code review H4/H5 : routes accessibles sans vérification de propriété
- N'importe quel utilisateur pouvait laisser un avis sur n'importe quelle commande
- Fix : vérification `order.initiatorId === reviewerId` au service level

### 2. Agrégation en mémoire vs DB
- Implémentation initiale calculait `avgRating` en JavaScript
- Code review M2 : migration vers `prisma.sellerReview.aggregate()`
- Performance nettement meilleure, surtout avec volume croissant

### 3. Test mock pollution (bug debugging)
- `vi.clearAllMocks()` ne clear PAS la queue `mockResolvedValueOnce`
- Tests de validation (422) qui n'exécutaient pas le preHandler laissaient des mocks non consommés
- Fix : `mockReset()` sur tous les mocks controllables dans `beforeEach`
- **Ce bug a pris le plus de temps à diagnostiquer dans tout le sprint**

### 4. Relations Prisma manquantes
- Pas de relation Order ↔ SellerReview initialement
- Ajouté en code review M6 : back-relations `sellerReviews`, `disputes` sur Order
- `deliveryReviews` sur Delivery

## Insights clés

1. **Les vérifications de propriété sont OBLIGATOIRES** — ne jamais faire confiance à l'auth seule pour les opérations CRUD
2. **Prisma aggregate** est toujours préférable au calcul en mémoire pour les métriques
3. **`vi.clearAllMocks()` ≠ `vi.resetAllMocks()`** — le premier ne vide PAS la queue des `mockResolvedValueOnce`
4. **Les relations Prisma bidirectionnelles** doivent être ajoutées dès la création du modèle, pas après

## Dette technique

| Item | Priorité | Notes |
|------|----------|-------|
| Badge "Bon Mécano" automatique | Medium | Logique seuil ≥4.2/5, ≥10 ratings — stub |
| Perceptual hash fraud detection | Low | Phase 2 |
| Contestation d'avis abusif | Low | API prête, UI à créer |

---

*Rétrospective facilitée par Bob (Scrum Master) — générée le 2026-03-01*
